(() => {
  const anchor = document.getElementById("bookAnchor");
  const canvas = document.getElementById("embers");
  const ctx = canvas.getContext("2d", { alpha: true });

  let w = 0, h = 0, dpr = 1;
  let running = false;
  let raf = 0;
  const sparks = [];
  const MAX = 90;

  function resize() {
    const rect = canvas.getBoundingClientRect();
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    w = rect.width;
    h = rect.height;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function rand(a, b) {
    return Math.random() * (b - a) + a;
  }

  function spawn() {
    const r = Math.random();
    let x, y, vx, vy;

    if (r < 0.6) {
      x = rand(w*0.72, w*0.95);
      y = rand(h*0.18, h*0.85);
      vx = rand(0.05, 0.2);
      vy = rand(-0.6, -0.2);
    } else {
      x = rand(w*0.15, w*0.85);
      y = rand(h*0.05, h*0.18);
      vx = rand(-0.1, 0.1);
      vy = rand(-0.5, -0.15);
    }

    sparks.push({
      x, y,
      vx, vy,
      r: rand(0.8, 2.2),
      a: rand(0.4, 0.8),
      life: rand(40, 70),
      t: 0
    });

    if (sparks.length > MAX) sparks.shift();
  }

  function loop() {
    raf = requestAnimationFrame(loop);
    ctx.clearRect(0,0,w,h);
    for (let i=0;i<3;i++) spawn();

    for (let i = sparks.length - 1; i >= 0; i--) {
      const s = sparks[i];
      s.t++;
      const p = s.t / s.life;
      if (p >= 1) {
        sparks.splice(i,1);
        continue;
      }

      s.x += s.vx;
      s.y += s.vy;
      const alpha = s.a * (1 - p);

      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(120,200,255,${alpha})`;
      ctx.fill();
    }
  }

  function start() {
    if (running) return;
    running = true;
    resize();
    sparks.length = 0;
    loop();
  }

  function stop() {
    running = false;
    cancelAnimationFrame(raf);
    ctx.clearRect(0,0,w,h);
  }

  anchor.addEventListener("mouseenter", start);
  anchor.addEventListener("mouseleave", stop);
  window.addEventListener("resize", resize, { passive: true });
})();